# 负载均衡模型

负载均衡的一个原则是对于客户端用户，IP永远是唯一且稳定的。

1. NAT模型(非负载均衡，路由器实现)：

![image](https://user-images.githubusercontent.com/20439371/126032045-490fdad7-963f-4834-81ac-231b44f8fe0f.png)

* 在局域网中，不同机器如果在同一时间，同事访问外网的某个网址，会出现一个问题：

    * 两台机器都到达路由器，路由器会将两个机器的数据包发给下一跳的地址，从而访问到目的服务。此时两个数据包的源地址，都是路由器地址。
    * 当服务返回到路由器的时候，路由器同时接到两个来自同一外网的数据包，此时的路由器无法判断哪一个数据包该返还给内网的哪一个客户机器

![image](https://user-images.githubusercontent.com/20439371/126032059-6fdb937a-2e39-4852-8e32-7f92557b8f48.png)

* 为了解决这个问题，路由器会做如下操作：
    * 再创建一张表
    * 每当有一个数据包来，路由器会申请一个端口号
    * 用申请的端口号替换请求的端口号
    * 将申请的端口号，和源端口号以及源IP地址的映射写进表里
    * 用申请的端口号+路由器IP地址向目的地址发送数据包，因为端口号是每次都申请，所以端口号不会重复
    * 当数据返回时，根据返回的端口号(路由器申请的)去表内查看源端口号和源IP地址
    * 按照查询结果返回数据包

![image](https://user-images.githubusercontent.com/20439371/126032076-24406da6-2539-4dcb-bbc2-57bb07533790.png)


2. D-NAT模型

![image](https://user-images.githubusercontent.com/20439371/126032108-abdd3924-4baf-459a-830b-7f9aa01a4015.png)


* 负载均衡器将自己的VIP暴漏给客户端。
* 当客户端请求到达时。负载均衡器将请求中的源地址由CIP换成DIP，目的IP由VIP换成RIP发给Service。(不转换直接转发的话，到了service端，因为)
* 服务器返回信息给负载均衡器，负载均衡器再替换服务端数据包的目的IP：DIP->CIP，源IP: RIP-VIP再返还给客户端。

>弊端：

* 带宽会成为负载均衡的瓶颈
* 负载均衡的地址转换，也是一个负担。
* 单点的负载均衡服务器，一旦挂掉，整个网站下线

> 优点

* 负载均衡器仅仅做数据包的转发，不做任何额外处理，速度快。包括握手，也是客户端和最终服务器端进行握手，而并不是跟负载均衡握手。（这一点有别与反向代理，反向代理是先握手，再负载）
* 因为涉及到修改IP,负载均衡器是基于4层的。

3. DR模型

![image](https://user-images.githubusercontent.com/20439371/126032136-413cf750-0c5e-47b3-b645-5f8ecb14406c.png)


由于D-NET的模型，网络带宽会变成一个瓶颈，考虑服务器的返回数据包不再走负载均衡器，而直接返还给客户端。
> 难度

* 直接返回给客户端，则返还的数据包中，源数据IP是RIP。当客户端接收到这个数据包时，因为客户端并不知道RIP的存在，也从未给RIP发过数据包，此时收到了RIP回应的数据包，就会将其丢弃，通信终止。

* 解决方法：

    * 需要在服务端的每一台主机上配置一个隐藏的VIP(必须是隐藏的，负责局域网内的服务器的IP会冲突)，这样会在路由表中形成VIP-CIP的映射，以便服务端可以跳过负载均衡直接把数据包发送给客户端。隐藏的VIP不可以绑定在eth0上，要绑在lo上。
    * 负载均衡器收到来在客户端的数据包，不需要对IP做任何处理，直接负载到服务端。因为服务端绑定了隐藏的VIP，所以服务端不会丢掉来自客户端(CIP->VIP)的包。
    * 负载均衡器虽然不需要对IP做处理，但是需要将下一跳的Mac地址封装成服务器的Mac地址，否则包发不出去
    * 由此可知，负载均衡器需要跟服务器在同一个网络内，不可以跨网络。
* 因为不涉及到修改IP, 只是Mac地址的改动，负载均衡器是基于2层的

4. TUN模型

![image](https://user-images.githubusercontent.com/20439371/126032192-781eaa98-6308-4e03-9577-a14e618faa80.png)


因为DR模型要求负载均衡器和服务端必须在同一网络，则产生了一定的局限性。要解决这个问题，就要用的TUN模型。感觉上，TUN模型在负载均衡器和服务端创建了一个通道，这个通道是如何创建的呢？

  * 负载均衡器将源数据包(CIP->VIP)外层重新包括一层，使外层的数据包看起来是(DIP -> RIP)的。
  * 在到达RIP之前，数据包都以外面那一层封装示人，知道跳到服务端。
  * 服务端收到数据包之后，撕掉外层的包裹，拿出CIP-VIP的映射，就可以直接返回数据包给CIP。
  * VPN技术
